---
title: "Machine learning"
output: html_document
---

```{r}
library(dplyr)

data <- read.table("../trade//rf/world_TF_comp.csv.gz", 
                header = T, 
                sep = ",",
                nrows = 1191653,
                stringsAsFactors = F,
                colClasses = c("integer", 
                               "integer",
                               "character",
                               "integer",
                               "integer",
                               "numeric",
                               "numeric",
                               "numeric",
                               "integer",
                               "integer"))

# Number of countries
data %>%
  select(reporter) %>%
  distinct() %>%
  nrow()

# Number of FCL
data %>%
  select(fcl_code) %>%
  distinct() %>%
  nrow()

# Number of FCL
data %>%
  select(hs_code) %>%
  distinct() %>%
  nrow()

# Number of FCL
data %>%
  select(hs_code) %>%
  distinct() %>%
  nrow()

data %>%
  filter(reporter == 138, partner == 2,
         fcl_code == 18)
```


```{r}
# DF for learning
data <- data %>%
  rename(hs      = hs_code,
         fcl     = fcl_code,
         qty     = source.orig_qty,
         qty2    = source.other_qty,
         value   = source.value,
         qty.fcl = valid.qty,
         vl.fcl  = valid.value) %>%
  mutate(reporter = factor(reporter),
         partner  = factor(partner),
         hs       = factor(hs),
         fcl      = factor(fcl),
         flow     = factor(flow))

set.seed(124)
train <- sample.int(nrow(data), 10000)

data1 <- data[train, ] %>%
  select(-qty.fcl, -vl.fcl) %>%
  droplevels()



inTrain <- caret::createDataPartition(data$fcl,
                               p = .001,
                               list = F)

d_tr <- data[inTrain,]
rf1 <- train(fcl ~ ., data = d_tr, 
             method = 'rf',
             trControl = trainControl(method = "cv",number = 1),
             prox = TRUE)

foreign::write.arff(data1, file = "../trade//rf/train10000.arff")

```

```{r}
rf2 <- randomForest::randomForest(fcl ~ ., data = data1)
```

```{r}
rf1 <- bigrf::bigrfc(data1[, -4], data1$fcl, 10L)
```

## 1st of Feb

Reduce size of dataset and try RF model training.

## 2nd of Feb

Is there only one year? In this case only one HS item can exist in area/partner/year/flow.

```{r}
data %>%
  group_by(reporter, partner, flow, hs) %>%
  mutate(n = n()) %>%
  filter(n > 1) ->
  dupls
```
Many double rows with duplicated FCL quantity and value.

```{r}
dupls %>%
  mutate(qty.fcl1 = lead(qty.fcl),
         vl.fcl1 = lead(vl.fcl)) %>%
  filter(!is.na(qty.fcl1) | !is.na(vl.fcl1)) %>%
  filter(qty.fcl != qty.fcl1)

getswsct(area = faoarea(10), year = 2011, partner = faoarea(9), item = "220300", testcodes = T)
```

Length of HS codes
```{r}
table(nchar(as.character(data$hs)))
```


Test dataset
```{r}
testdata <- data[-train,] %>%
  filter(reporter %in% levels(data1$reporter),
         partner %in% levels(data1$partner),
         hs %in% levels(data1$hs),
         fcl %in% levels(data1$fcl)) %>%
  rename(fcl.orig = fcl)

foreign::write.arff(testdata, file = "../trade//rf/test.arff")

pred <- read.table("../trade//rf/preds.tsv", header = F, sep = '\t')
nrow(pred) == nrow(testdata)
testdata <- cbind(testdata, pred$V2)
names(testdata)[dim(testdata)[2]] <- "fcl.pred"
testdata %>%
  mutate(matched = as.numeric(fcl.pred == fcl.orig)) %>%
  group_by(matched) %>%
  summarise(n = n()) %>%
  mutate(prop = n / sum(n))
```


[ep@centos7 ~]$ go/bin/growforest -train train10000.arff -rfpred forest10000.rf -target fcl -nTrees 10
Threads : 1
nTrees : 10
Loading data from: train10000.arff
Target : fcl
Non Target Features : 7
mTry : 3
non-missing cases: 10000
leafSize : 1
nSamples : 10000
Performing classification with 440 categories.
Total training time (seconds): 6970.390662117

  matched      n
1       0 583749
2       1 305731 34%


~/go/bin/growforest -train train20000.arff -rfpred forest20000.rf -target fcl -nTrees 10 -nCores 8

Threads : 8
nTrees : 10
Loading data from: train20000.arff
Target : fcl
Non Target Features : 7
mTry : 3
non-missing cases: 20000
leafSize : 1
nSamples : 20000
Performing classification with 464 categories.
Total training time (seconds): 1669.619664377

~/go/bin/applyforest -fm test.arff -rfpred forest20000.rf -preds preds.tsv

  matched      n      prop
1       0 631016 0.6374079
2       1 358956 0.3625921


[sas@localhost rf]$ ~/go/bin/growforest -train train10000.arff -rfpred forest10000.rf -target fcl -nTrees 50 -nCores 8
Threads : 8
nTrees : 50
Loading data from: train10000.arff
Target : fcl
Non Target Features : 7
mTry : 3
non-missing cases: 10000
leafSize : 1
nSamples : 10000
Performing classification with 433 categories.
Total training time (seconds): 1731.072929593


  matched      n      prop
1       0 531598 0.5968364
2       1 359095 0.4031636