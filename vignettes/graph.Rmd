---
title: "Graphs"
author: "Aleksandr Matrunich"
date: "02/13/2015"
output: html_document
---

```{r}
library(dplyr)
library(stringr)
library(igraph)
library(reshape2)

areacodes2names <- function(code) {
  factor(code,
         levels = unique(code),
         labels = sapply(unique(code), 
                         function(x) {
                           faoareanames$name[faoareanames$fao == x]
                           }))
  }
  

data <- read.table("../trade//rf/world_TF_comp.csv.gz", 
                   header = T, 
                   sep = ",",
                   nrows = 1191653,
                   stringsAsFactors = F,
                   colClasses = c("integer", 
                                  "integer",
                                  "character",
                                  "integer",
                                  "integer",
                                  "numeric",
                                  "numeric",
                                  "numeric",
                                  "integer",
                                  "integer")) %>%
  rename(hs      = hs_code,
         fcl     = fcl_code,
         qty     = source.orig_qty,
         qty2    = source.other_qty,
         value   = source.value,
         qty.fcl = valid.qty,
         vl.fcl  = valid.value) %>%
  mutate(reporter = areacodes2names(reporter),
         partner  = areacodes2names(partner),
         hs6      = factor(stringr::str_extract(hs, "^.{6}")),
         fcl      = factor(fcl),
         flow     = factor(flow),
         qty2     = qty2,
         value    = value) %>%
  select(-hs) %>%
  rename(hs = hs6)


```

```{r}

linksgroups <- function(hs, fcl) {
  
  data <- data.frame(hs, fcl) %>%
    mutate_(hs  = ~paste0("hs", hs), #HS and FCL with similar number become one node
            fcl = ~paste0("fcl", fcl)) 
  
  nodes <- data %>%
    reshape2::melt(measure.vars  = c('hs', 'fcl'),
                   variable.name = "classif",
                   value.name    = "code") %>%
    distinct_() %>%
    select_(~code, ~classif)
  
  grph <- data %>%
    igraph::graph.data.frame(vertices = nodes)
  
  grph.df <- igraph::get.data.frame(grph, what = 'vertices')
  
  grph.df$membership <- factor(igraph::clusters(grph)$membership)
  
  grph.df %>%
    filter_(~classif == "hs") %>%
    mutate_(hs = ~factor(stringr::str_extract(name, "\\d.*$"))) %>%
    select_(~hs, ~membership)
  }

```

```{r}
g1 <- data.frame(
  from = c("u", "u", "u", "m", "m", "m", "hs1", "hs2", "hs3"),
  to   = c("hs1", "hs2", "hs3", "hs1", "hs2", "hs3", "f1", "f2", "f3")) %>%
  graph.data.frame()
```

```{r}
conv.prop <- function(data, dec = 2) {
  data %>%
    select_(~hs, ~fcl, ~qty, ~qty2, ~qty.fcl, ~value, ~vl.fcl) %>%
    lapply(function(x) {
      if(is.character(x) | is.factor(x)) return(x) # Don't get props of character values
      round(prop.table(x), dec)
  }) %>%
    as.data.frame()
  }
  
data %>%
  rename(hs = hs6) %>%
  conv.prop

d <- plyr::ddply(data[data$reporter == 41,], c("flow", "reporter", "partner"), function(x) {
  x <- x %>%
  left_join(linksgroups(x$hs, x$fcl), by = 'hs')
  
  prop <- function(x) round(x / sum(as.numeric(x)), 2)
  
  x %>%
    group_by_(~membership) %>%
    mutate_(qty     = ~prop(qty),
            qty2    = ~prop(qty2),
            value   = ~prop(value),
            qty.fcl = ~prop(qty.fcl),
            vl.fcl  = ~prop(vl.fcl))
  })


x %>%
  group_by(membership) %>%
  mutate(qty = qty / sum(qty))

    conv.prop()

data <- data %>%
  left_join(linksgroups(data$hs, data$fcl), by = 'hs')  

d1 <- data %>%
  group_by(flow, reporter, partner, membership) %>%
  mutate_(qty     = ~prop(qty),
          qty2    = ~prop(qty2),
          value   = ~prop(value),
          qty.fcl = ~prop(qty.fcl),
          vl.fcl  = ~prop(vl.fcl))

table(d1$membership)

d1 %>%
  ungroup() %>%
  select(fcl, hs, membership) %>%
  distinct() %>%
  group_by(membership) %>%
  summarize(n = n()) %>%
  filter(n == 5)

d1 %>%
  group_by(flow, reporter, partner) %>%
  filter(membership == 10,
         reporter   == "Australia") %>%
  mutate(link = paste0(hs, "_", fcl),
         qdif = qty2 - qty.fcl,
         vdif = value - vl.fcl) %>%
  ggplot(aes(link, vdif)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~ partner) +
  scale_y_continuous(labels = percent, limits = 0:1)

d2 <- d1 %>%
  group_by(flow, reporter, partner, membership) %>%
    mutate(qdif = qty2 - qty.fcl,
           vdif = value - vl.fcl) %>%
  summarize(quan.sd = sd(qdif, na.rm = T),
         val.sd = sd(vdif, na.rm = T)) 

d2 %>%
  group_by(flow) %>%
  summarize(q = mean(quan.sd, na.rm = T),
            v = mean(val.sd, na.rm = T))

d2 %>%
  group_by(reporter) %>%
  summarize(q = mean(quan.sd, na.rm = T),
            v = mean(val.sd, na.rm = T)) %>%
  reshape2::melt(value.name = "mean.sd", variable.name = "item") %>%
  ggplot(aes(mean.sd, color = item)) + geom_density()
```

